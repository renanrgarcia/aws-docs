# ALB

- **Application Load Balancer (ALB) (v2 - new generation 2016)**: Operates at the application layer (Layer 7)
- Load balancing to multiple HTTP/HTTPS applications across machines (target groups).
- Load balancing to multiple applications on the same machine (ex: different ports, containers).
- Supports HTTP/2 and WebSocket protocols. Also supports redirects.
- Routing tables to different target groups based on:
  - URL path (path-based routing) (e.g., /api goes to target group 1, /images goes to target group 2)
  - Host field in the HTTP header (host-based routing) (e.g., api.example.com goes to target group 1, images.example.com goes to target group 2)
  - Query string or HTTP header (advanced request routing) (e.g., version=beta goes to target group 1, version=stable goes to target group 2)
    - Another example: mobile (?Platform=mobile) vs desktop (?Platform=desktop)
- Great for microservices and container-based architectures (Docker, ECS, EKS).
- Has a port mapping feature to redirect to a dynamic port in ECS.
  - In comparison, we'd need multiple CLBs per application.

## Target Groups

- A target group is a logical grouping of targets (like EC2 instances, IP addresses, or Lambda functions) that the ALB routes requests to.
- Types of target groups:
  - `EC2 Instances`: Routes traffic to EC2 instances using their instance ID.
    - Can be managed by an Auto Scaling group - HTTP
  - `ECS Tasks`: Routes traffic to ECS tasks using their IP address.
    - Managed by an ECS service - HTTP
  - `Lambda functions`: HTTP requests are translated into JSON events and sent to the Lambda function.
  - `IP addresses`: Routes traffic to IP addresses.
    - Can be used for on-premises resources or resources outside the VPC - HTTP
    - Must be private IPs within the VPC CIDR range.
- Health checks are performed on each target in the group to determine its availability.
- ALB can route traffic to multiple target groups based on the rules defined in the listener.

## Good to know

- Fixed hostname (xxx.region.elb.amazonaws.com) that can be used in DNS records.
- The application servers don't see the real IP of the client, but the IP of the ALB.
  - To get the real IP, we can use the `X-Forwarded-For` HTTP header and `X-Forwarded-Proto` for the protocol (HTTP or HTTPS).
  - Modify the backend application to get the real IP from the `X-Forwarded-For` header.

## Listeners and Rules

- A listener is a process that checks for connection requests. It is configured with a protocol and port number.
- Rules define how the load balancer routes requests to target groups based on conditions. Types: path-based, host-based, HTTP header, query string.
- Each listener has a default rule that routes requests to a default target group if no other rules match.
- Examples:
  - If the path is `/api/*`, route to the `api` target group.
  - If the host is `images.example.com`, route to the `images` target group.
